# AI 기반 UI 기능

<!-- affects: frontend, llm, api -->
<!-- requires-update: 02_api/api-contracts.md, 04_frontend/ -->

## 이 문서가 답하는 질문

- Canvas에서 AI/LLM이 관여하는 UI 기능은 무엇인가?
- AI 출력의 불확실성을 UI에서 어떻게 표현하는가?
- HITL(Human-in-the-Loop) 원칙은 어떤 UI 패턴으로 구현되는가?
- AI 실패 시 프론트엔드에서 어떻게 대응하는가?

---

## 1. AI 기능 분류

### 1.1 Canvas의 AI 활용 영역

```
┌──────────────────────────────────────────────────────────────────┐
│                    AI 기능 스펙트럼                                │
│                                                                   │
│  ◄── 결정적 (Deterministic) ──────── 비결정적 (Non-deterministic) ──►│
│                                                                   │
│  ┌──────────┐  ┌────────────┐  ┌────────────┐  ┌──────────────┐│
│  │ OLAP 쿼리 │  │ 차트 추천   │  │ NL2SQL     │  │ 문서 AI 생성 ││
│  │ (확정적)  │  │ (규칙 기반) │  │ (LLM 기반) │  │ (LLM 기반)  ││
│  │           │  │             │  │            │  │              ││
│  │ Vision API│  │ Oracle API  │  │ Oracle API │  │ Core API     ││
│  │ 서버 집계 │  │ 결과 분석   │  │ SSE 스트림 │  │ AI 초안 생성 ││
│  └──────────┘  └────────────┘  └────────────┘  └──────────────┘│
│                                                                   │
│  Canvas가 직접 LLM을 호출하지 않음                               │
│  모든 AI는 백엔드 서비스를 통해 간접 사용                        │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 1.2 AI 기능 목록

| # | 기능 | 서비스 | AI 역할 | 불확실성 수준 |
|---|------|--------|---------|-------------|
| 1 | **문서 AI 생성** | Core | 업무 문서 초안 작성 | 높음 - HITL 필수 |
| 2 | **NL2SQL 변환** | Oracle | 자연어 -> SQL 생성 | 중간 - SQL 확인 가능 |
| 3 | **차트 자동 추천** | Oracle | 결과에 적합한 차트 타입 제안 | 낮음 - 규칙 기반 |
| 4 | **온톨로지 자동 매핑** | Synapse | 데이터소스 -> 온톨로지 매핑 제안 | 중간 - 확인 필요 |
| 5 | **이상 탐지 알림** | Core | 데이터 패턴 이상 감지 | 중간 - 오탐 가능 |
| 6 | **문서 요약** | Core | 긴 문서의 핵심 요약 | 높음 - 맥락 손실 가능 |

---

## 2. AI 출력 UI 패턴

### 2.1 AI 생성 표시 (AI Attribution)

```
┌─ AI 생성 콘텐츠 ────────────────────────────────────────────┐
│                                                              │
│  🤖 AI 생성                                                 │
│  ─────────────────────────────────────────────────           │
│  이 문서는 AI가 생성한 초안입니다.                           │
│  정확성 검증이 필요합니다.                                   │
│                                                              │
│  [콘텐츠 영역]                                               │
│  ...                                                         │
│                                                              │
│  ┌─ AI 메타데이터 ────────────────────────────────────────┐ │
│  │ 모델: GPT-4o │ 생성일: 2024-03-10 │ 신뢰도: - │       │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  [승인] [수정 요청] [반려]                                   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 AI 불확실성 표현 규칙

| 불확실성 수준 | UI 표현 | 사용자 액션 요구 |
|-------------|---------|------------------|
| **높음** | 🤖 배지 + 경고 배너 + HITL 워크플로우 강제 | 반드시 인간 검토 후 승인 |
| **중간** | 🤖 배지 + "확인 필요" 툴팁 | 확인 버튼 표시, 건너뛰기 가능 |
| **낮음** | 작은 🤖 아이콘 | 정보성, 액션 불필요 |

### 2.3 결정적 vs 비결정적 UI 차이

```
결정적 (OLAP 쿼리 결과):
┌──────────────────────────────────┐
│ 결과: 1,234건 │ 실행시간: 1.2초 │   <- 확정적, 신뢰도 표시 없음
│ [테이블 데이터]                   │
└──────────────────────────────────┘

비결정적 (NL2SQL 결과):
┌──────────────────────────────────┐
│ 🤖 AI 생성 SQL                   │   <- AI 표시
│ 결과: 10건 │ 실행시간: 2.5초    │
│                                   │
│ ⚠ 생성된 SQL이 의도와 다를 수   │   <- 불확실성 고지
│   있습니다. SQL을 확인해 주세요. │
│                                   │
│ [SQL 보기/수정] [실행] [취소]    │   <- HITL: SQL 확인 기회
└──────────────────────────────────┘
```

---

## 3. HITL 패턴 구현

### 3.1 문서 AI 생성 HITL 흐름

```
[AI 생성 요청]
      │
      ▼
[Core API: POST /documents/ai-generate]
      │
      ▼
[AI 초안 수신]
      │
      ├── status: 'draft'
      ├── aiGenerated: true
      └── reviewStatus: 'pending'
      │
      ▼
[문서 편집기에 표시]
      │
      ├── 🤖 배지 표시
      ├── "AI 생성 초안" 배너
      └── Diff 뷰어 활성화 (원본 vs 수정)
      │
      ▼
[HITL 리뷰 시작]
      │
      ├── 검토자 배정 (자동 또는 수동)
      ├── 인라인 코멘트 추가
      ├── 수정사항 반영
      └── AI 원본 대비 수정률 표시
      │
      ▼
[최종 승인/반려]
      │
      ├── 승인: status -> 'approved', 수정률 메트릭 저장
      └── 반려: status -> 'rejected', 사유 기록
```

### 3.2 NL2SQL HITL 흐름

```
[자연어 질문 입력]
      │
      ▼
[Oracle API SSE 스트리밍]
      │
      ├── 1단계: "분석 중..." (thinking)
      ├── 2단계: SQL 표시 (sql_generated) ← HITL 포인트
      │     │
      │     ├── 사용자가 SQL 확인 -> [실행]
      │     └── 사용자가 SQL 수정 -> [수정 후 실행]
      │
      ├── 3단계: "실행 중..." (executing)
      └── 4단계: 결과 표시 (result)
```

---

## 4. AI 실패 처리

### 4.1 실패 시나리오별 UI 대응

| 실패 유형 | 원인 | UI 대응 |
|-----------|------|---------|
| **AI 서비스 다운** | LLM API 장애 | "AI 서비스를 일시적으로 사용할 수 없습니다. 수동으로 작성하시겠습니까?" |
| **생성 타임아웃** | 복잡한 문서 생성 지연 | 30초 후 "생성이 지연되고 있습니다. 계속 대기하시겠습니까?" |
| **NL2SQL 변환 실패** | 질문 이해 불가 | "질문을 이해하지 못했습니다. 더 구체적으로 입력해 주세요." + 예시 질문 표시 |
| **SQL 실행 오류** | 생성된 SQL 문법 오류 | "생성된 SQL에 오류가 있습니다." + SQL 편집기로 전환 |
| **빈 결과** | 조건에 맞는 데이터 없음 | "조건에 맞는 데이터가 없습니다. 조건을 변경해 보세요." |

### 4.2 AI 실패 시 Fallback 전략

```
AI 기능 실패
    │
    ├── 재시도 가능?
    │   ├── YES: [다시 시도] 버튼 표시 (최대 2회)
    │   └── NO: 수동 모드로 전환 안내
    │
    ├── 대안 기능 있음?
    │   ├── NL2SQL 실패 -> SQL 직접 입력 모드 제공
    │   ├── AI 문서 생성 실패 -> 빈 문서 템플릿 제공
    │   └── 차트 추천 실패 -> 기본 테이블 뷰 표시
    │
    └── 에러 로깅
        └── 실패 정보를 Core API에 전송 (개선 데이터)
```

---

## 5. AI 기능 설정

### 5.1 사용자별 AI 설정 (Settings 페이지)

```
AI 기능 설정
├── 문서 AI 생성: [활성화●]
│   └── 자동 생성 vs 요청 시 생성: [요청 시 ▼]
├── NL2SQL: [활성화●]
│   └── SQL 자동 실행: [확인 후 실행 ▼] / 즉시 실행
├── 차트 자동 추천: [활성화●]
├── 이상 탐지 알림: [활성화●]
│   └── 민감도: [중간 ▼] / 높음 / 낮음
└── AI 생성 표시: [항상 표시●] (끄기 불가)
```

---

## 6. Canvas -> 백엔드 AI 경계

### 금지됨 (Forbidden)

- 프론트엔드에서 직접 LLM API (OpenAI, Anthropic 등) 호출
- AI 응답을 검증 없이 최종 결과로 표시 (HITL 우회)
- AI 생성 여부 표시 없이 콘텐츠 표시

### 필수 (Required)

- 모든 AI 생성 콘텐츠에 🤖 표시
- 높은 불확실성 AI 출력은 반드시 HITL 워크플로우 적용
- AI 실패 시 수동 대안 제공
- AI 메타데이터(모델, 생성일) 표시

---

## 결정 사항 (Decisions)

- Canvas는 LLM을 직접 호출하지 않음 (모든 AI는 백엔드 서비스 경유)
  - 근거: API 키 노출 방지, 프롬프트 관리 중앙화, 비용 제어
  - LLM은 비결정적이므로 백엔드에서 결과 검증 후 전달

- AI 생성 표시는 사용자가 끌 수 없음
  - 근거: 투명성 원칙, 업무 문서 도메인에서 AI 출력 구분은 필수

---

## 변경 이력

| 날짜 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2026-02-19 | 1.0 | Axiom Team | 초기 작성 |
