# Canvas 프론트엔드 아키텍처 개요

<!-- affects: frontend, api -->
<!-- requires-update: 04_frontend/directory-structure.md, 02_api/api-client.md, 04_frontend/process-designer.md -->

## 이 문서가 답하는 질문

- Canvas 애플리케이션의 전체 아키텍처는 어떻게 구성되는가?
- 왜 이런 아키텍처를 선택했는가?
- 각 계층의 책임은 무엇이며, 어디까지가 경계인가?
- K-AIR의 멀티 프론트엔드 구조에서 무엇이 달라지는가?

---

## 1. 아키텍처 원칙

### 1.1 핵심 원칙

| 원칙 | 설명 | 위반 시 결과 |
|------|------|-------------|
| **단방향 데이터 흐름** | 데이터는 항상 Store -> Component -> Action -> Store 방향으로 흐른다 | 상태 추적 불가, 디버깅 난이도 증가 |
| **서버 상태/클라이언트 상태 분리** | 서버 데이터는 TanStack Query, UI 상태는 Zustand | 캐시 무효화 복잡도 증가 |
| **기능 기반 모듈화** | 기술(component, hook)이 아닌 기능(case, document, olap) 기준 구조 | 파일 탐색 시간 증가, 의존성 복잡 |
| **점진적 로딩** | 라우트 기반 코드 분할 + Suspense | 초기 번들 크기 폭발 |
| **타입 우선 계약** | API 응답은 반드시 TypeScript 인터페이스로 정의 | 런타임 에러, AI 문서 불일치 |

### 1.2 K-AIR 아키텍처의 문제점과 Canvas의 해결

| K-AIR 문제 | Canvas 해결 |
|------------|-------------|
| 4개 분리된 Vue 앱 -> 일관성 없는 UX | 단일 React SPA로 통합 |
| Vuetify + Tailwind + Headless UI 혼재 | Shadcn/ui 단일 디자인 시스템 |
| Pinia store가 컴포넌트에 강결합 | Zustand의 React 외부 접근 가능 store |
| mitt() 이벤트 버스 -> 추적 어려운 부수효과 | Zustand subscribe + TanStack Query invalidation |
| BackendFactory 패턴 (멀티 백엔드) | 단일 Axiom 백엔드, Axios 인터셉터 표준화 |
| Keycloak 인증 -> 복잡한 초기 설정 | JWT 토큰 기반, Core 서비스 인증 위임 |

---

## 2. 전체 아키텍처 다이어그램

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          브라우저 (Chrome/Edge)                           │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     React 애플리케이션 셸                        │    │
│  │  ┌────────────────────────────────────────────────────────┐    │    │
│  │  │  App Shell                                              │    │    │
│  │  │  - <ErrorBoundary>                                      │    │    │
│  │  │  - <AuthProvider>                                       │    │    │
│  │  │  - <QueryClientProvider>                                │    │    │
│  │  │  - <ThemeProvider> (다크모드)                            │    │    │
│  │  │  - <RouterProvider>                                     │    │    │
│  │  └────────┬───────────────────────────────────────────────┘    │    │
│  │           │                                                     │    │
│  │  ┌────────▼───────────────────────────────────────────────┐    │    │
│  │  │  레이아웃 레이어                                         │    │    │
│  │  │  ┌──────────┐  ┌──────────────────────────────────┐   │    │    │
│  │  │  │ Sidebar  │  │ Content Area                      │   │    │    │
│  │  │  │ (Nav)    │  │ ┌────────────────────────────┐   │   │    │    │
│  │  │  │          │  │ │  Page (Lazy Loaded)         │   │   │    │    │
│  │  │  │ - 대시보드│  │ │  ┌──────────────────────┐ │   │   │    │    │
│  │  │  │ - 문서   │  │ │  │ Feature Components    │ │   │   │    │    │
│  │  │  │ - 분석   │  │ │  │ ┌──────┐ ┌──────┐   │ │   │   │    │    │
│  │  │  │ - 데이터 │  │ │  │ │Shared│ │Shared│   │ │   │   │    │    │
│  │  │  │ - 설정   │  │ │  │ └──────┘ └──────┘   │ │   │   │    │    │
│  │  │  │          │  │ │  └──────────────────────┘ │   │   │    │    │
│  │  │  └──────────┘  │ └────────────────────────────┘   │   │    │    │
│  │  │                 └──────────────────────────────────┘   │    │    │
│  │  └────────────────────────────────────────────────────────┘    │    │
│  │                                                                 │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  상태 관리 레이어                                         │  │    │
│  │  │                                                           │  │    │
│  │  │  ┌─────────────┐  ┌──────────────────────────────────┐  │  │    │
│  │  │  │  Zustand     │  │  TanStack Query                  │  │  │    │
│  │  │  │  Stores      │  │  Cache                           │  │  │    │
│  │  │  │              │  │                                   │  │  │    │
│  │  │  │ - authStore  │  │  - useCases()                    │  │  │    │
│  │  │  │ - uiStore    │  │  - useDocuments()                │  │  │    │
│  │  │  │ - themeStore │  │  - useScenarios()                │  │  │    │
│  │  │  │ - sidebarSt. │  │  - useOlapQuery()                │  │  │    │
│  │  │  │ - processDe. │  │  - useOntologyNodes()             │  │  │    │
│  │  │  │   signerSt.  │  │  - useNl2sql()                    │  │  │    │
│  │  │  │              │  │  - useDatasources()               │  │  │    │
│  │  │  │              │  │  - useProcessBoard()              │  │  │    │
│  │  │  └─────────────┘  └──────────────────────────────────┘  │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  API 통신 레이어                                          │  │    │
│  │  │                                                           │  │    │
│  │  │  ┌───────────────────────────────────────────────────┐   │  │    │
│  │  │  │  Axios Client Factory                              │   │  │    │
│  │  │  │  - 인증 인터셉터 (JWT 자동 첨부)                   │   │  │    │
│  │  │  │  - 에러 인터셉터 (401 -> 리프레시 -> 재시도)       │   │  │    │
│  │  │  │  - 요청/응답 로깅                                   │   │  │    │
│  │  │  └──────┬──────────┬──────────┬──────────┬────────┬──┘   │  │    │
│  │  │         │          │          │          │        │       │  │    │
│  │  │    coreApi    visionApi  oracleApi  synapseApi  weaverApi │  │    │
│  │  │                                                           │  │    │
│  │  │  ┌───────────────────────────────────────────────────┐   │  │    │
│  │  │  │  WebSocket Manager                                │   │  │    │
│  │  │  │  - Core WebSocket (알림, 케이스 이벤트)            │   │  │    │
│  │  │  │  - 자동 재연결 + 지수 백오프                       │   │  │    │
│  │  │  └───────────────────────────────────────────────────┘   │  │    │
│  │  │                                                           │  │    │
│  │  │  ┌───────────────────────────────────────────────────┐   │  │    │
│  │  │  │  SSE Manager                                      │   │  │    │
│  │  │  │  - Oracle SSE (NL2SQL 스트리밍)                   │   │  │    │
│  │  │  │  - Weaver SSE (동기화 진행률)                     │   │  │    │
│  │  │  └───────────────────────────────────────────────────┘   │  │    │
│  │  │                                                           │  │    │
│  │  │  ┌───────────────────────────────────────────────────┐   │  │    │
│  │  │  │  Yjs WebSocket Provider                           │   │  │    │
│  │  │  │  - 비즈니스 프로세스 디자이너 실시간 협업          │   │  │    │
│  │  │  │  - CRDT 문서 동기화 + Awareness (커서/선택)       │   │  │    │
│  │  │  │  - 자동 재연결 + 오프라인 큐잉                    │   │  │    │
│  │  │  └───────────────────────────────────────────────────┘   │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
         │              │              │              │              │
         ▼              ▼              ▼              ▼              ▼
    Core 서비스    Vision 서비스   Oracle 서비스   Synapse 서비스  Weaver 서비스
```

---

## 3. 계층별 책임

### 3.1 4계층 아키텍처

```
┌─────────────────────────────────────────────────┐
│  Presentation Layer (표현 계층)                   │
│  - Pages, Layouts, Feature Components            │
│  - JSX 렌더링, 이벤트 핸들링                      │
│  - Suspense boundaries, Error boundaries         │
├─────────────────────────────────────────────────┤
│  State Layer (상태 계층)                          │
│  - Zustand stores (클라이언트 상태)               │
│  - TanStack Query hooks (서버 상태)              │
│  - Custom hooks (비즈니스 로직)                   │
├─────────────────────────────────────────────────┤
│  Service Layer (서비스 계층)                      │
│  - API 함수 (순수 함수, React 무관)              │
│  - 요청/응답 타입 변환                            │
│  - 에러 정규화                                    │
├─────────────────────────────────────────────────┤
│  Infrastructure Layer (인프라 계층)               │
│  - Axios 인스턴스                                 │
│  - WebSocket/SSE 매니저                           │
│  - 로컬 스토리지 어댑터                           │
│  - 로깅, 모니터링                                 │
└─────────────────────────────────────────────────┘
```

### 3.2 계층 간 규칙

#### 허용됨 (Allowed)
- Presentation -> State (hooks 호출)
- Presentation -> Shared Components (재사용 컴포넌트)
- State -> Service (API 함수 호출)
- Service -> Infrastructure (Axios 사용)
- Custom Hook -> Zustand Store + TanStack Query

#### 금지됨 (Forbidden)
- Presentation -> Service 직접 호출 (반드시 hook을 통해)
- Presentation -> Infrastructure 직접 접근 (Axios 직접 사용 금지)
- Service -> Zustand Store 접근 (서비스는 순수 함수)
- 순환 의존 (A -> B -> A)
- Feature 간 직접 import (반드시 shared를 통해)

---

## 4. 동시성 및 실시간 통신

### 4.1 통신 패턴별 사용처

| 패턴 | 프로토콜 | 사용처 | 설명 |
|------|----------|--------|------|
| **요청-응답** | HTTP REST | CRUD 전체 | 표준 데이터 조회/변경 |
| **서버 푸시** | WebSocket | Watch 알림, 케이스 이벤트 | 양방향, 상시 연결 |
| **CRDT 동기화** | Yjs WebSocket | 비즈니스 프로세스 디자이너 | 다중 사용자 실시간 협업, 충돌 자동 해소 |
| **스트리밍** | SSE | NL2SQL 결과, 데이터 동기화 | 단방향, 진행률 표시 |
| **폴링** | HTTP GET + interval | OLAP 장기 쿼리 상태 | TanStack Query refetchInterval |

### 4.2 WebSocket 연결 관리

```
[앱 시작] ──→ [인증 완료] ──→ [WS 연결 시도]
                                    │
                              ┌─────┴─────┐
                              │            │
                         [연결 성공]   [연결 실패]
                              │            │
                         [이벤트 수신]  [지수 백오프]
                              │            │
                              │       [재시도 (최대 5회)]
                              │            │
                         [Store 업데이트] [오프라인 모드]
                              │
                         [UI 반영]
```

### 4.3 비즈니스 프로세스 디자이너 데이터 흐름

```
┌──────────────────────────────────────────────────────────────────┐
│              비즈니스 프로세스 디자이너 데이터 흐름                 │
│                                                                    │
│  ┌─────────────────┐    ┌──────────────────┐                      │
│  │  ProcessCanvas   │◄──►│  Yjs Document     │ (CRDT 상태)         │
│  │  (react-konva)   │    │  - nodes Map      │                      │
│  │                   │    │  - connections Map │                      │
│  │  노드 배치/편집   │    │  - positions Map  │                      │
│  └───────┬───────────┘    └────────┬─────────┘                      │
│          │                          │                                │
│          │ 사용자 편집              │ y-websocket                   │
│          ▼                          ▼                                │
│  ┌─────────────────┐    ┌──────────────────┐                      │
│  │  Zustand Store   │    │  Yjs WebSocket    │                      │
│  │  (로컬 UI 상태)  │    │  Server           │◄──► 다른 사용자      │
│  │  - toolMode      │    │                    │                      │
│  │  - selectedItems │    └──────────────────┘                      │
│  │  - collaborators │                                                │
│  └───────┬───────────┘                                              │
│          │                                                          │
│          │ 프로세스 마이닝 요청                                     │
│          ▼                                                          │
│  ┌─────────────────┐    ┌──────────────────┐                      │
│  │  TanStack Query  │───►│  Synapse API      │                      │
│  │  - useProcess    │    │  /process-mining   │                      │
│  │    Mining()      │    │  - conformance     │                      │
│  │  - useProcess    │    │  - bottleneck      │                      │
│  │    Board()       │    │  - variants        │                      │
│  └─────────────────┘    └──────────────────┘                      │
│                                                                    │
│  Canvas ◄──► Yjs WS   : 실시간 협업 (CRDT 동기화)                 │
│  Canvas ──► Synapse    : 프로세스 마이닝 결과 조회 (REST)          │
│  Canvas ──► Core       : 보드 메타데이터 저장 (REST)               │
│                                                                    │
└──────────────────────────────────────────────────────────────────┘
```

---

## 5. 에러 처리 전략

### 5.1 에러 경계 계층

```
┌─────────────────────────────────────────────┐
│  Global Error Boundary (앱 레벨)             │
│  - 미처리 에러 포착                           │
│  - "문제가 발생했습니다" 풀페이지              │
│  - 에러 로깅 -> 모니터링                      │
│                                               │
│  ┌─────────────────────────────────────────┐ │
│  │  Route Error Boundary (페이지 레벨)     │ │
│  │  - 페이지 로딩 실패                      │ │
│  │  - "이 페이지를 표시할 수 없습니다"      │ │
│  │  - 다른 페이지 이동은 가능                │ │
│  │                                          │ │
│  │  ┌──────────────────────────────────┐   │ │
│  │  │  Feature Error Boundary          │   │ │
│  │  │  - 위젯/패널 단위 실패 격리       │   │ │
│  │  │  - "데이터를 불러올 수 없습니다"  │   │ │
│  │  │  - 재시도 버튼 제공               │   │ │
│  │  └──────────────────────────────────┘   │ │
│  └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

### 5.2 API 에러 처리 흐름

```
API 호출 실패
    │
    ├── 401 Unauthorized
    │     ├── 리프레시 토큰으로 재발급 시도
    │     │     ├── 성공: 원래 요청 재시도
    │     │     └── 실패: 로그인 페이지 리다이렉트
    │     └── (1회만 재시도)
    │
    ├── 403 Forbidden
    │     └── "권한이 없습니다" 토스트 + 이전 페이지 유지
    │
    ├── 404 Not Found
    │     └── "리소스를 찾을 수 없습니다" + 목록으로 이동
    │
    ├── 422 Validation Error
    │     └── 필드별 에러 메시지 표시 (폼 인라인)
    │
    ├── 429 Rate Limited
    │     └── "잠시 후 다시 시도해 주세요" + 자동 재시도
    │
    ├── 500+ Server Error
    │     └── "서버 오류가 발생했습니다" + 재시도 버튼
    │
    └── Network Error
          └── "네트워크 연결을 확인해 주세요" + 오프라인 배너
```

---

## 6. 성능 전략

### 6.1 번들 최적화

| 전략 | 기법 | 목표 |
|------|------|------|
| **코드 분할** | React.lazy + Suspense per route | 초기 번들 < 200KB (gzip) |
| **트리 셰이킹** | ES module import, Vite 자동 | 미사용 코드 제거 |
| **청크 분리** | Vite manualChunks | vendor, common, feature 분리 |
| **프리로딩** | `<link rel="prefetch">` | 다음 페이지 미리 로드 |

### 6.2 렌더링 최적화

| 전략 | 기법 | 적용 영역 |
|------|------|-----------|
| **메모이제이션** | `React.memo`, `useMemo`, `useCallback` | 복잡한 목록, 차트 |
| **가상 스크롤** | TanStack Virtual | 대량 테이블 (1000+ rows) |
| **지연 로딩** | Intersection Observer | 화면 밖 차트/이미지 |
| **낙관적 업데이트** | TanStack Query optimistic | 문서 상태 변경, 리뷰 액션 |

---

## 결정 사항 (Decisions)

- 단일 SPA로 모든 기능 통합 (MFE 아닌 모노리식 프론트엔드)
  - 근거: 8개 기능이 공통 컨텍스트(케이스)를 공유하므로 상태 공유가 필수
  - 재평가 조건: 팀 규모 10명 이상 + 독립 배포 필요 시 MFE 검토

- BFF 계층 없이 직접 백엔드 서비스 호출
  - 근거: 5개 서비스가 이미 Canvas 요구에 맞춘 API 제공
  - 재평가 조건: API 조합이 3개 이상 필요한 화면 5개 이상 시 BFF 도입 검토

## 사실 (Facts)

- React 18.x + TypeScript 5.x (Strict mode)
- Vite 5.x 빌드 시스템
- 타깃 브라우저: Chrome 90+, Edge 90+, Safari 15+

---

## 변경 이력

| 날짜 | 버전 | 작성자 | 내용 |
|------|------|--------|------|
| 2026-02-20 | 1.1 | Axiom Team | 비즈니스 프로세스 디자이너 데이터 흐름 추가, Yjs WebSocket Provider 추가, CRDT 동기화 패턴 추가 |
| 2026-02-19 | 1.0 | Axiom Team | 초기 작성 |
