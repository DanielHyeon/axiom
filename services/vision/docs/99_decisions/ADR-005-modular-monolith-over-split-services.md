# ADR-005: 단일 Vision 서비스(모듈러 모놀리스) 유지

## 상태

Accepted

## 배경

Vision은 OLAP, What-if, Root Cause 엔진을 포함한다. 초기 설계에서는 엔진별 별도 서비스 분리도 검토했지만, 공통 데이터 모델과 인증/권한 처리, 배포 복잡도를 함께 고려해야 했다.

## 결정

- Vision은 단일 FastAPI 서비스로 유지한다.
- 내부는 `engines/olap`, `engines/what_if`, `engines/root_cause`로 모듈 분리한다.
- 엔진 간 호출은 Python import가 아니라 service layer를 통해서만 수행한다.

## 근거

1. 공통 DB 세션/권한 모델을 서비스 하나에서 일관되게 강제할 수 있다.
2. 엔진 간 데이터 교환(큐브 메타, 시나리오 결과, 인과 그래프)의 네트워크 오버헤드를 제거한다.
3. 운영 복잡도(배포 파이프라인, 오토스케일 정책, 장애 추적)를 초기 단계에서 낮출 수 있다.

## 결과

### 긍정적

- 배포 단순화: 단일 이미지, 단일 헬스체크, 단일 롤백 절차
- 데이터 일관성: 트랜잭션 경계와 권한 정책을 단일 코드베이스에서 관리
- 개발 속도: 엔진 간 API 계약 협의 비용 최소화

### 부정적

- 특정 엔진만 독립 스케일 아웃하기 어렵다.
- 코드베이스가 커지면 모듈 경계가 약해질 위험이 있다.

## 보완 규칙

- CPU 집약 경로는 백그라운드 잡/큐 기반 비동기로 분리한다.
- 엔진별 SLO(응답시간, 에러율) 메트릭을 분리 수집한다.
- 엔진 경계 위반(직접 import)은 CI 정적 검사로 차단한다.

## 재검토 조건

- OLAP/What-if/Root Cause 중 하나의 피크 트래픽이 전체의 70% 이상을 지속 점유할 때
- 엔진별 릴리스 주기가 달라 단일 배포가 병목이 될 때
- 보안/컴플라이언스 요구로 런타임 격리가 필요해질 때
