# ADR-002: Synapse 백엔드 Neo4j 벡터 인덱스 활용

## 상태

Accepted

## 배경

Oracle의 NL2SQL 파이프라인은 사용자 질문에 관련된 테이블/컬럼을 찾기 위해 **벡터 유사도 검색**이 필요하다. 동시에 FK 관계를 따라 그래프 탐색을 수행해야 한다. 단, Oracle은 그래프 저장소에 직접 접근하지 않고 Synapse API를 경유한다.

이 두 가지 요구를 충족하는 저장소를 선택해야 한다:

1. **Neo4j 벡터 인덱스**: Synapse 백엔드 그래프 DB에 벡터 검색 기능 통합
2. **별도 벡터 DB + Neo4j**: Pinecone/Weaviate/pgvector + Neo4j 분리
3. **PostgreSQL pgvector**: 벡터 검색을 PostgreSQL에서 처리

K-AIR는 Neo4j 5의 네이티브 벡터 인덱스를 사용하고 있다. Axiom에서는 이 기능을 Synapse가 소유/운영하고 Oracle은 API로 사용한다.

## 고려한 옵션

### 옵션 A: Synapse 백엔드 Neo4j 벡터 인덱스 (통합)

**장점**:
- Synapse 내부에서 벡터 검색과 그래프 탐색을 **단일 쿼리**로 수행
- FK 경로 탐색이 Synapse 내부에서 벡터 검색과 같은 트랜잭션으로 실행
- 운영 대상 DB가 1개 (인프라 단순화)
- K-AIR 검증된 구현

**단점**:
- Neo4j의 벡터 검색 성능은 전문 벡터 DB보다 낮을 수 있음
- 벡터 인덱스 갱신이 그래프 성능에 영향 가능
- HNSW 인덱스 옵션이 제한적

### 옵션 B: 별도 벡터 DB + Neo4j

**장점**:
- 전문 벡터 DB의 높은 검색 성능
- 벡터/그래프 각각 독립 확장

**단점**:
- 두 시스템 간 데이터 동기화 필요
- 벡터 검색 결과와 그래프 탐색을 별도 쿼리로 실행 후 합쳐야 함
- 운영 복잡도 증가 (2개 DB 관리)
- K-AIR 코드 재사용 불가 (검색 로직 전면 재작성)

### 옵션 C: PostgreSQL pgvector

**장점**:
- Target DB와 동일 시스템에서 벡터 검색
- PostgreSQL 기반 SQL 쿼리로 접근 가능

**단점**:
- FK 그래프 탐색에 재귀 CTE 필요 (Neo4j보다 복잡)
- 5축 벡터 검색의 병렬 실행이 어려움
- K-AIR 코드 전면 재작성 필요

## 선택한 결정

**옵션 A: Synapse 백엔드 Neo4j 벡터 인덱스 (통합)**

## 근거

1. **벡터 + 그래프의 자연스러운 결합**: Synapse 내부에서 테이블 벡터 검색 -> FK 경로 탐색을 단일 Cypher 쿼리로 수행할 수 있다. 분리 시 이 흐름이 2번의 네트워크 왕복과 결과 합침으로 복잡해진다.

2. **K-AIR 검증**: `graph_search.py`(352줄) 기반 검색 전략이 Neo4j 벡터 인덱스 환경에서 검증됨.

3. **인프라 단순화**: 스타트업 단계에서 관리 대상 DB를 최소화하는 것이 운영 부담을 줄인다.

4. **충분한 성능**: Oracle의 벡터 검색 대상은 수천~수만 개의 테이블/컬럼 노드. 이 규모에서 Neo4j HNSW 인덱스의 성능은 충분하다 (수십 밀리초).

5. **값 매핑 통합**: ValueMapping 노드도 같은 그래프에 있어 벡터 검색 -> 값 매핑 조회 -> FK 탐색이 일관된 데이터 모델에서 이루어진다.

## 서비스 경계 제약

- Oracle은 Neo4j에 직접 접속하지 않는다.
- Oracle의 그래프 검색/캐시 반영은 Synapse REST API를 통해 수행한다.
- Neo4j 스키마/인덱스 운영 책임은 Synapse에 있다.

## 결과

### 긍정적 영향

- 그래프 검색 코드의 단순성 유지
- K-AIR 코드 직접 이식 가능
- 데이터 일관성 보장 (단일 DB)

### 부정적 영향

- 대규모 벡터 데이터 시 Neo4j 성능 한계 가능
- Neo4j 커뮤니티 에디션의 제약 (노드 수 제한 등)

### 완화 전략

- 벡터 인덱스 대상을 `text_to_sql_is_valid=true`인 노드로 한정
- 검색 결과 캐싱 (Redis, TTL 5분)
- 성능 모니터링으로 병목 조기 감지
- 대규모 전환 시 옵션 B(별도 벡터 DB) 재검토

## 재평가 조건

- 테이블/컬럼 노드가 100,000개를 초과할 때
- 벡터 검색 지연이 500ms를 초과할 때
- Neo4j 라이선스 비용이 문제가 될 때

---

**근거 문서**: [06_data/neo4j-schema.md](../06_data/neo4j-schema.md)
**영향 문서**: [03_backend/graph-search.md](../03_backend/graph-search.md)
