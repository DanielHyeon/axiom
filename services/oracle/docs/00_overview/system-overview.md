# Oracle 모듈 시스템 개요

## 이 문서가 답하는 질문

- Oracle 모듈은 무엇이고, Axiom 플랫폼에서 어떤 역할을 하는가?
- NL2SQL 파이프라인은 어떤 흐름으로 동작하는가?
- 비즈니스 프로세스 인텔리전스에서 Oracle이 해결하는 문제는 무엇인가?
- Oracle은 어떤 기술 스택 위에 구축되는가?

<!-- affects: 01_architecture, 02_api, 05_llm -->
<!-- requires-update: 01_architecture/architecture-overview.md -->

---

## 1. Oracle이란

**Axiom Oracle**은 "질문에 데이터의 언어로 답하는 영매(Oracle)" 모듈이다.

사용자가 자연어로 던진 질문을 SQL로 변환하고, 데이터베이스에서 실행한 결과를 사람이 이해할 수 있는 형태로 되돌려주는 **NL2SQL(Natural Language to SQL) 엔진**이다.

### 1.1 핵심 정체성

| 속성 | 설명 |
|------|------|
| 이름 | Axiom Oracle |
| 은유 | "데이터의 영매" - 사람의 말을 데이터의 언어(SQL)로 통역 |
| 도메인 | 비즈니스 프로세스 인텔리전스 |
| 핵심 기능 | 자연어 -> SQL 변환, ReAct 추론, SQL 안전성 검증, 이벤트 감지 |
| 출자 | K-AIR `robo-data-text2sql-main` (구현 완성도 95%) |

### 1.2 Axiom 플랫폼 내 위치

```
┌─────────────────────────────────────────────────────────────────┐
│                      Axiom AI Data Platform                     │
│              비즈니스 프로세스 인텔리전스 플랫폼                  │
│                                                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌───────────┐ │
│  │   Vision   │  │   Oracle   │  │  Synapse   │  │  Weaver   │ │
│  │  문서 처리  │  │  NL2SQL    │  │ 에이전트   │  │ 데이터    │ │
│  │  OCR/분석  │  │  ReAct     │  │ 오케스트라 │  │ 패브릭    │ │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬─────┘ │
│        │               │               │               │        │
│  ┌─────┴───────────────┴───────────────┴───────────────┴─────┐ │
│  │                    Core (공통 인프라)                       │ │
│  │          인증 / 이벤트 버스 / 감시(Watch) / 로깅           │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              데이터 레이어                                  │ │
│  │   PostgreSQL  |  Neo4j  |  Redis  |  Vector Store          │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 Oracle이 해결하는 문제

**비즈니스 데이터 접근 장벽**:

1. **전문 용어 장벽**: "프로세스 성공률" 같은 질문을 SQL로 작성하려면 DB 스키마와 비즈니스 용어를 모두 알아야 함
2. **복잡한 조인**: 비즈니스 데이터는 다수의 테이블에 분산되어 있어 FK 관계 파악이 필수
3. **안전성 요구**: 민감한 비즈니스 데이터에 대한 무분별한 쿼리 실행 방지 필요
4. **반복 질문**: 유사한 질문이 반복되지만 매번 SQL을 새로 작성하는 비효율

**Oracle의 해결 방식**:

| 문제 | 해결 방식 |
|------|----------|
| 전문 용어 | 5축 벡터 검색으로 자연어-DB 스키마 의미 매핑 |
| 복잡한 조인 | Synapse API가 제공하는 FK 그래프에서 최대 3홉 경로 자동 탐색 |
| 안전성 | SQL Guard (SELECT-only, LIMIT 강제, 서브쿼리 깊이 제한) |
| 반복 질문 | 품질 게이트 통과 쿼리를 Synapse 백엔드 그래프 캐시에 반영 후 벡터 검색으로 재활용 |

---

## 2. NL2SQL 파이프라인 요약

Oracle의 핵심은 **8단계 NL2SQL 파이프라인**이다.

```
사용자 질문 (자연어)
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. 임베딩 생성                                               │
│    자연어 질문 → 벡터 (OpenAI text-embedding-3-small 등)     │
├─────────────────────────────────────────────────────────────┤
│ 2. 그래프 검색 (5축 벡터 유사도 + FK 3홉)                    │
│    question_vector / hyde_vector / regex / intent / PRF      │
│    → 관련 테이블, 컬럼, 기존 쿼리 후보군 추출                │
├─────────────────────────────────────────────────────────────┤
│ 3. 스키마 포맷팅                                             │
│    추출된 테이블/컬럼 → CREATE TABLE DDL 형태로 정규화       │
├─────────────────────────────────────────────────────────────┤
│ 4. SQL 생성 (LangChain + GPT-4o)                            │
│    프롬프트: 스키마 + 질문 + 값 매핑 + 규칙 → SQL 출력      │
├─────────────────────────────────────────────────────────────┤
│ 5. SQL 검증 (SQLGlot + SQL Guard)                           │
│    구문 파싱, DML 차단, JOIN 깊이/서브쿼리 깊이 제한        │
├─────────────────────────────────────────────────────────────┤
│ 6. SQL 실행 (asyncpg / aiomysql)                            │
│    타임아웃 30초, 최대 10,000행, 응답 1,000행 제한           │
├─────────────────────────────────────────────────────────────┤
│ 7. 시각화 추천                                               │
│    결과 컬럼 타입 분석 → 차트 유형(bar/line/pie) 자동 추천   │
├─────────────────────────────────────────────────────────────┤
│ 8. 결과 캐싱 (품질 게이트)                                   │
│    LLM 심사 N회 → 신뢰도 >= 0.90 → Neo4j Query 노드 영속화  │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
응답 (SQL + 데이터 + 시각화 추천 + 요약)
```

---

## 3. 기술 스택

### 3.1 핵심 기술

| 계층 | 기술 | 용도 |
|------|------|------|
| LLM | GPT-4o (OpenAI) | SQL 생성, 품질 심사, 시각화 추천 |
| 프레임워크 | LangChain | 프롬프트 체인, ReAct 에이전트 |
| 그래프 DB | Neo4j 5 | 스키마 그래프, 벡터 인덱스, 쿼리 캐시 |
| SQL 파서 | SQLGlot | SQL 구문 분석, 방언 변환, 구조 검증 |
| 임베딩 | OpenAI text-embedding-3-small | 질문/스키마/쿼리 벡터화 |
| 웹 프레임워크 | FastAPI | 비동기 API 서버 |
| DB 드라이버 | asyncpg / aiomysql | PostgreSQL/MySQL 비동기 실행 |
| 캐시 | Redis | 세션, 임시 결과 |

### 3.2 K-AIR 원본 소스 구성

K-AIR `robo-data-text2sql-main`에서 이식하는 핵심 소스:

| 파일 | 줄 수 | 역할 |
|------|-------|------|
| `app/routers/ask.py` | - | NL2SQL 메인 엔드포인트 |
| `app/core/graph_search.py` | 352 | Neo4j 5축 벡터 검색 |
| `app/core/prompt.py` | 112 | LangChain SQL 생성 프롬프트 |
| `app/core/sql_exec.py` | 380 | SQL 실행 (asyncpg/aiomysql) |
| `app/core/sql_guard.py` | 153 | SQL 안전성 검증 |
| `app/core/llm_factory.py` | 213 | LLM 팩토리 (멀티 프로바이더) |
| `app/core/embedding.py` | 55 | 텍스트 벡터화 |
| `app/core/viz.py` | 297 | 시각화 추천 |
| `app/core/cache_postprocess.py` | 1,977 | 백그라운드 쿼리/값매핑 영속화 |
| `app/core/enum_cache_bootstrap.py` | 513 | Enum 값 캐싱 |
| `app/routers/feedback.py` | - | 피드백 수집 |
| `app/routers/meta.py` | - | 메타데이터 탐색 |
| `app/models/history.py` | - | 쿼리 이력 (K-AIR 레거시: SQLite) |

---

## 4. 사용자 유형과 사용 시나리오

### 4.1 사용자 역할

| 역할 | Oracle 사용 방식 |
|------|-----------------|
| **비즈니스 분석가** | "이 프로젝트의 총 수익은?" 같은 자연어 질의 |
| **운영 담당자** | 프로세스 통계 조회, 기간별 추이 분석 |
| **데이터 분석가** | 직접 SQL 실행, 시각화 결과 활용 |
| **시스템 관리자** | 메타데이터 관리, 피드백 기반 품질 개선 |
| **AI/LLM 시스템** | ReAct 에이전트를 통한 다단계 추론 |

### 4.2 주요 사용 시나리오

**시나리오 1: 단순 조회**
```
사용자: "2024년 매출 성장률이 가장 높은 사업부는?"
Oracle: SQL 생성 → 실행 → "2024년 매출 성장률이 가장 높은 사업부는 디지털사업부(32%)입니다."
        + 사업부별 성장률 bar chart 추천
```

**시나리오 2: 복합 추론 (ReAct)**
```
사용자: "작년 대비 프로세스 성공률이 가장 많이 변동한 조직 TOP 5는?"
Oracle: [ReAct 에이전트]
  → Think: 2024년과 2023년 프로세스 성공률을 조직별로 비교해야 함
  → Act: 2024년 조직별 성공률 SQL 실행
  → Observe: 결과 확인
  → Act: 2023년 조직별 성공률 SQL 실행
  → Observe: 결과 확인
  → Think: 변동률 계산 후 TOP 5 추출
  → Answer: 결과 + 비교 차트
```

**시나리오 3: 이벤트 감시**
```
관리자: "프로세스 마일스톤 기한 3일 전 알림 룰 등록"
Oracle: 이벤트 룰 등록 → 주기적 SQL 실행 → 조건 충족 시 알림 발생
```

---

## 5. 용어 사전

| 용어 | 설명 |
|------|------|
| **NL2SQL** | Natural Language to SQL. 자연어를 SQL 쿼리로 변환하는 기술 |
| **ReAct** | Reasoning + Acting. LLM이 사고(Think)와 행동(Act)을 반복하며 문제를 해결하는 패턴 |
| **5축 벡터 검색** | question, HyDE, regex, intent, PRF(Pseudo Relevance Feedback) 5가지 축으로 벡터 유사도 검색 |
| **SQL Guard** | SQL 안전성 검증기. DML 차단, JOIN 깊이 제한, 서브쿼리 깊이 제한 등 |
| **SQLGlot** | SQL 파서/트랜스파일러. SQL 구문 분석과 방언 변환 수행 |
| **FK 3홉** | Foreign Key 관계를 최대 3단계까지 그래프 탐색하여 관련 테이블 발견 |
| **품질 게이트** | 생성된 SQL/매핑을 LLM이 N회 심사하여 신뢰도 기준 이상만 캐시에 영속화 |
| **CEP** | Complex Event Processing. 이벤트 스트림에서 복합 패턴을 감지하는 기술 |
| **HyDE** | Hypothetical Document Embedding. 질문에 대한 가상 답변을 생성한 후 그 임베딩으로 검색하는 기법 |
| **PRF** | Pseudo Relevance Feedback. 초기 검색 결과를 기반으로 쿼리를 보강하는 기법 |
| **값 매핑** | 자연어 값("본사")과 DB 실제 값("HQ_001") 사이의 매핑 |
| **비즈니스 프로세스** | 조직이 목표를 달성하기 위해 수행하는 일련의 활동 흐름 |
| **프로세스 인텔리전스** | 비즈니스 프로세스 데이터를 분석하여 인사이트를 도출하고 미래를 예측하는 기술 |
| **디지털 트윈** | 비즈니스 프로세스의 디지털 복제본을 통해 시뮬레이션 및 예측을 수행하는 기술 |

---

## 6. K-AIR 출자 현황

### 6.1 이식 범위

| 원본 (K-AIR) | 대상 (Axiom Oracle) | 이식 방식 |
|-------------|--------------------|-----------|
| `robo-data-text2sql-main` | `services/oracle` | 전면 이식 후 비즈니스 도메인 적응 |
| NL2SQL 파이프라인 | 동일 구조 유지 | 5축 벡터 검색 + ReAct 그대로 |
| SQL Guard | 동일 구조 유지 | 비즈니스 도메인 화이트리스트 추가 |
| 이벤트/CEP | Core Watch로 이관 | SimpleCEP → Core 공통 모듈로 분리 |
| Neo4j 스키마 | 확장 | 비즈니스 프로세스 도메인 노드/관계 추가 |

### 6.2 변경 사항

| 항목 | K-AIR 원본 | Axiom Oracle |
|------|-----------|-------------|
| 도메인 | 범용 | 비즈니스 프로세스 인텔리전스 |
| DB 타겟 | MySQL + PostgreSQL | PostgreSQL 중심 |
| 인증 | Keycloak + Supabase | Core 통합 인증 |
| 이벤트 | SimpleCEP (내장) | Core Watch (외부 모듈) |
| 이력 저장 | SQLite | PostgreSQL |
| 멀티테넌트 | X-Forwarded-Host | Core 테넌트 관리 |

---

## 관련 문서

- [01_architecture/architecture-overview.md](../01_architecture/architecture-overview.md): 전체 아키텍처
- [01_architecture/nl2sql-pipeline.md](../01_architecture/nl2sql-pipeline.md): NL2SQL 파이프라인 상세
- [02_api/text2sql-api.md](../02_api/text2sql-api.md): API 스펙
- [05_llm/react-agent.md](../05_llm/react-agent.md): ReAct 에이전트
- [99_decisions/ADR-001-langchain-sql.md](../99_decisions/ADR-001-langchain-sql.md): LangChain 선택 배경
