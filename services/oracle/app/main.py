from contextlib import asynccontextmanager

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from app.api.text2sql import router as text2sql_router
from app.api.health import router as health_router
from app.api.feedback import router as feedback_router
from app.api.meta import router as meta_router
from app.api.events import router as events_router, watch_agent_router
from app.core.rate_limit import RateLimitExceeded
from app.core.config import settings
import structlog

logger = structlog.get_logger()


# ---------------------------------------------------------------------------
# Demo seed: create tables + insert sample data so NL2SQL has real data
# ---------------------------------------------------------------------------
_SEED_DDL = """
CREATE TABLE IF NOT EXISTS sales (
    id          SERIAL PRIMARY KEY,
    company_name VARCHAR(100)  NOT NULL,
    department  VARCHAR(50),
    sale_date   DATE          NOT NULL,
    product_category VARCHAR(50),
    revenue     NUMERIC(15,2) NOT NULL,
    cost        NUMERIC(15,2),
    quantity    INTEGER,
    region      VARCHAR(50)
);

CREATE TABLE IF NOT EXISTS operations (
    id              SERIAL PRIMARY KEY,
    case_ref        VARCHAR(100),
    operation_type  VARCHAR(50)   NOT NULL,
    started_at      TIMESTAMP     NOT NULL,
    completed_at    TIMESTAMP,
    duration_minutes NUMERIC(10,2),
    status          VARCHAR(20),
    region          VARCHAR(50),
    operator_name   VARCHAR(100)
);
"""

_SEED_DATA = """
-- Sales data (서울전자, 한국테크, 부산물산, 대전로보틱스, 인천소프트)
INSERT INTO sales (company_name, department, sale_date, product_category, revenue, cost, quantity, region) VALUES
-- 서울전자
('서울전자', '반도체사업부', '2024-01-15', '반도체',     1250000000, 875000000,  5000, '서울'),
('서울전자', '디스플레이사업부', '2024-01-20', '디스플레이', 980000000,  686000000,  3200, '서울'),
('서울전자', '반도체사업부', '2024-02-10', '반도체',     1380000000, 966000000,  5500, '서울'),
('서울전자', '디스플레이사업부', '2024-02-18', '디스플레이', 1020000000, 714000000,  3400, '서울'),
('서울전자', '반도체사업부', '2024-03-05', '반도체',     1420000000, 994000000,  5700, '서울'),
('서울전자', 'IT솔루션사업부', '2024-03-12', 'IT솔루션',  560000000,  336000000,  1200, '서울'),
('서울전자', '반도체사업부', '2024-04-08', '반도체',     1510000000, 1057000000, 6000, '서울'),
('서울전자', '디스플레이사업부', '2024-04-22', '디스플레이', 1100000000, 770000000,  3600, '서울'),
('서울전자', '반도체사업부', '2024-05-14', '반도체',     1600000000, 1120000000, 6400, '서울'),
('서울전자', 'IT솔루션사업부', '2024-05-28', 'IT솔루션',  620000000,  372000000,  1350, '서울'),
('서울전자', '반도체사업부', '2024-06-10', '반도체',     1550000000, 1085000000, 6200, '서울'),
('서울전자', '디스플레이사업부', '2024-06-20', '디스플레이', 1150000000, 805000000,  3800, '서울'),
('서울전자', 'IT솔루션사업부', '2024-06-20', 'IT솔루션',  580000000,  348000000,  1250, '서울'),
('서울전자', '반도체사업부', '2024-07-03', '반도체',     1680000000, 1176000000, 6700, '서울'),
('서울전자', '디스플레이사업부', '2024-07-15', '디스플레이', 1200000000, 840000000,  4000, '서울'),
('서울전자', '반도체사업부', '2024-08-09', '반도체',     1720000000, 1204000000, 6900, '서울'),
('서울전자', 'IT솔루션사업부', '2024-08-20', 'IT솔루션',  650000000,  390000000,  1400, '서울'),
('서울전자', '반도체사업부', '2024-09-12', '반도체',     1780000000, 1246000000, 7100, '서울'),
('서울전자', '디스플레이사업부', '2024-09-25', '디스플레이', 1250000000, 875000000,  4200, '서울'),
('서울전자', '반도체사업부', '2024-10-07', '반도체',     1850000000, 1295000000, 7400, '서울'),
('서울전자', 'IT솔루션사업부', '2024-10-18', 'IT솔루션',  700000000,  420000000,  1500, '서울'),
('서울전자', '반도체사업부', '2024-11-04', '반도체',     1900000000, 1330000000, 7600, '서울'),
('서울전자', '디스플레이사업부', '2024-11-20', '디스플레이', 1300000000, 910000000,  4400, '서울'),
('서울전자', '반도체사업부', '2024-12-02', '반도체',     1950000000, 1365000000, 7800, '서울'),
('서울전자', 'IT솔루션사업부', '2024-12-15', 'IT솔루션',  750000000,  450000000,  1600, '서울'),
-- 한국테크
('한국테크', '클라우드사업부', '2024-01-10', '클라우드',   890000000,  534000000,  2800, '경기'),
('한국테크', 'AI사업부',      '2024-02-15', 'AI솔루션',  720000000,  432000000,  1500, '경기'),
('한국테크', '클라우드사업부', '2024-03-20', '클라우드',   950000000,  570000000,  3000, '경기'),
('한국테크', 'AI사업부',      '2024-04-18', 'AI솔루션',  810000000,  486000000,  1700, '경기'),
('한국테크', '클라우드사업부', '2024-05-22', '클라우드',   1020000000, 612000000,  3200, '경기'),
('한국테크', 'AI사업부',      '2024-06-20', 'AI솔루션',  880000000,  528000000,  1900, '경기'),
('한국테크', '클라우드사업부', '2024-07-25', '클라우드',   1080000000, 648000000,  3400, '경기'),
('한국테크', 'AI사업부',      '2024-08-15', 'AI솔루션',  950000000,  570000000,  2100, '경기'),
('한국테크', '클라우드사업부', '2024-09-10', '클라우드',   1150000000, 690000000,  3600, '경기'),
('한국테크', 'AI사업부',      '2024-10-20', 'AI솔루션',  1020000000, 612000000,  2300, '경기'),
('한국테크', '클라우드사업부', '2024-11-12', '클라우드',   1200000000, 720000000,  3800, '경기'),
('한국테크', 'AI사업부',      '2024-12-08', 'AI솔루션',  1100000000, 660000000,  2500, '경기'),
-- 부산물산
('부산물산', '수출사업부', '2024-01-08', '원자재',     1560000000, 1248000000, 8000, '부산'),
('부산물산', '내수사업부', '2024-02-12', '건축자재',   780000000,  624000000,  4000, '부산'),
('부산물산', '수출사업부', '2024-03-18', '원자재',     1620000000, 1296000000, 8300, '부산'),
('부산물산', '내수사업부', '2024-04-25', '건축자재',   820000000,  656000000,  4200, '부산'),
('부산물산', '수출사업부', '2024-05-10', '원자재',     1700000000, 1360000000, 8700, '부산'),
('부산물산', '내수사업부', '2024-06-20', '건축자재',   860000000,  688000000,  4400, '부산'),
('부산물산', '수출사업부', '2024-07-15', '원자재',     1750000000, 1400000000, 9000, '부산'),
('부산물산', '내수사업부', '2024-08-22', '건축자재',   900000000,  720000000,  4600, '부산'),
('부산물산', '수출사업부', '2024-09-05', '원자재',     1800000000, 1440000000, 9200, '부산'),
('부산물산', '내수사업부', '2024-10-18', '건축자재',   940000000,  752000000,  4800, '부산'),
('부산물산', '수출사업부', '2024-11-08', '원자재',     1850000000, 1480000000, 9500, '부산'),
('부산물산', '내수사업부', '2024-12-20', '건축자재',   980000000,  784000000,  5000, '부산'),
-- 대전로보틱스
('대전로보틱스', '산업로봇사업부', '2024-01-22', '산업로봇', 650000000,  390000000,  120, '대전'),
('대전로보틱스', '자동화사업부',   '2024-03-10', '자동화장비', 420000000,  252000000,   85, '대전'),
('대전로보틱스', '산업로봇사업부', '2024-05-05', '산업로봇', 710000000,  426000000,  135, '대전'),
('대전로보틱스', '자동화사업부',   '2024-06-20', '자동화장비', 480000000,  288000000,   95, '대전'),
('대전로보틱스', '산업로봇사업부', '2024-08-12', '산업로봇', 780000000,  468000000,  150, '대전'),
('대전로보틱스', '자동화사업부',   '2024-10-03', '자동화장비', 530000000,  318000000,  105, '대전'),
('대전로보틱스', '산업로봇사업부', '2024-12-10', '산업로봇', 850000000,  510000000,  165, '대전'),
-- 인천소프트
('인천소프트', 'ERP사업부',   '2024-02-05', 'ERP',      340000000,  170000000,  50, '인천'),
('인천소프트', '보안사업부',   '2024-04-12', '보안솔루션', 280000000,  140000000,  40, '인천'),
('인천소프트', 'ERP사업부',   '2024-06-20', 'ERP',      380000000,  190000000,  55, '인천'),
('인천소프트', '보안사업부',   '2024-08-18', '보안솔루션', 320000000,  160000000,  45, '인천'),
('인천소프트', 'ERP사업부',   '2024-10-25', 'ERP',      410000000,  205000000,  60, '인천'),
('인천소프트', '보안사업부',   '2024-12-05', '보안솔루션', 350000000,  175000000,  50, '인천'),
-- 2025 sales data
('서울전자', '반도체사업부', '2025-01-14', '반도체',     2000000000, 1400000000, 8000, '서울'),
('서울전자', '디스플레이사업부', '2025-02-18', '디스플레이', 1350000000, 945000000,  4500, '서울'),
('서울전자', '반도체사업부', '2025-03-10', '반도체',     2100000000, 1470000000, 8400, '서울'),
('서울전자', 'IT솔루션사업부', '2025-04-15', 'IT솔루션',  800000000,  480000000,  1700, '서울'),
('서울전자', '반도체사업부', '2025-05-20', '반도체',     2200000000, 1540000000, 8800, '서울'),
('서울전자', '디스플레이사업부', '2025-06-12', '디스플레이', 1400000000, 980000000,  4700, '서울'),
('서울전자', '반도체사업부', '2025-07-08', '반도체',     2300000000, 1610000000, 9200, '서울'),
('서울전자', 'IT솔루션사업부', '2025-08-22', 'IT솔루션',  850000000,  510000000,  1800, '서울'),
('서울전자', '반도체사업부', '2025-09-15', '반도체',     2400000000, 1680000000, 9600, '서울'),
('서울전자', '디스플레이사업부', '2025-10-05', '디스플레이', 1500000000, 1050000000, 5000, '서울'),
('서울전자', '반도체사업부', '2025-11-10', '반도체',     2500000000, 1750000000, 10000, '서울'),
('서울전자', 'IT솔루션사업부', '2025-12-08', 'IT솔루션',  900000000,  540000000,  1900, '서울'),
('한국테크', '클라우드사업부', '2025-01-20', '클라우드',   1250000000, 750000000,  4000, '경기'),
('한국테크', 'AI사업부',      '2025-03-15', 'AI솔루션',  1150000000, 690000000,  2600, '경기'),
('한국테크', '클라우드사업부', '2025-05-10', '클라우드',   1350000000, 810000000,  4300, '경기'),
('한국테크', 'AI사업부',      '2025-07-08', 'AI솔루션',  1250000000, 750000000,  2800, '경기'),
('한국테크', '클라우드사업부', '2025-09-12', '클라우드',   1450000000, 870000000,  4600, '경기'),
('한국테크', 'AI사업부',      '2025-11-20', 'AI솔루션',  1350000000, 810000000,  3000, '경기'),
('부산물산', '수출사업부', '2025-02-08', '원자재',     1900000000, 1520000000, 9800, '부산'),
('부산물산', '내수사업부', '2025-04-18', '건축자재',   1020000000, 816000000,  5200, '부산'),
('부산물산', '수출사업부', '2025-06-10', '원자재',     2000000000, 1600000000, 10200, '부산'),
('부산물산', '내수사업부', '2025-08-15', '건축자재',   1060000000, 848000000,  5400, '부산'),
('부산물산', '수출사업부', '2025-10-20', '원자재',     2100000000, 1680000000, 10800, '부산'),
('부산물산', '내수사업부', '2025-12-12', '건축자재',   1100000000, 880000000,  5600, '부산'),
('대전로보틱스', '산업로봇사업부', '2025-02-15', '산업로봇', 900000000,  540000000,  170, '대전'),
('대전로보틱스', '자동화사업부',   '2025-05-20', '자동화장비', 580000000,  348000000,  115, '대전'),
('대전로보틱스', '산업로봇사업부', '2025-08-10', '산업로봇', 980000000,  588000000,  185, '대전'),
('대전로보틱스', '자동화사업부',   '2025-11-05', '자동화장비', 640000000,  384000000,  125, '대전'),
('인천소프트', 'ERP사업부',   '2025-01-25', 'ERP',      440000000,  220000000,  65, '인천'),
('인천소프트', '보안사업부',   '2025-04-08', '보안솔루션', 380000000,  190000000,  55, '인천'),
('인천소프트', 'ERP사업부',   '2025-07-15', 'ERP',      480000000,  240000000,  70, '인천'),
('인천소프트', '보안사업부',   '2025-10-22', '보안솔루션', 420000000,  210000000,  60, '인천'),
-- 2026 sales data (recent — within "최근 3개월")
('서울전자', '반도체사업부', '2026-01-12', '반도체',     2600000000, 1820000000, 10400, '서울'),
('서울전자', '디스플레이사업부', '2026-01-25', '디스플레이', 1550000000, 1085000000, 5200, '서울'),
('서울전자', '반도체사업부', '2026-02-10', '반도체',     2700000000, 1890000000, 10800, '서울'),
('한국테크', '클라우드사업부', '2026-01-18', '클라우드',   1550000000, 930000000,  4900, '경기'),
('한국테크', 'AI사업부',      '2026-02-12', 'AI솔루션',  1450000000, 870000000,  3200, '경기'),
('부산물산', '수출사업부', '2026-01-10', '원자재',     2200000000, 1760000000, 11200, '부산'),
('부산물산', '내수사업부', '2026-02-08', '건축자재',   1140000000, 912000000,  5800, '부산'),
('대전로보틱스', '산업로봇사업부', '2026-02-05', '산업로봇', 1050000000, 630000000,  200, '대전'),
('인천소프트', 'ERP사업부',   '2026-01-20', 'ERP',      500000000,  250000000,  75, '인천');

-- Operations data
INSERT INTO operations (case_ref, operation_type, started_at, completed_at, duration_minutes, status, region, operator_name) VALUES
('CASE-2024-001', '서류심사', '2024-01-10 09:00:00', '2024-01-10 11:30:00', 150,  'COMPLETED', '서울', '김민수'),
('CASE-2024-002', '현장실사', '2024-01-15 10:00:00', '2024-01-15 16:00:00', 360,  'COMPLETED', '부산', '이영희'),
('CASE-2024-003', '서류심사', '2024-02-05 09:30:00', '2024-02-05 12:00:00', 150,  'COMPLETED', '서울', '박준호'),
('CASE-2024-004', '현장실사', '2024-02-20 10:00:00', '2024-02-20 17:00:00', 420,  'COMPLETED', '대전', '최수진'),
('CASE-2024-005', '서류심사', '2024-03-08 09:00:00', '2024-03-08 10:30:00', 90,   'COMPLETED', '인천', '정하늘'),
('CASE-2024-006', '데이터분석', '2024-03-15 14:00:00', '2024-03-16 10:00:00', 1200, 'COMPLETED', '서울', '김민수'),
('CASE-2024-007', '현장실사', '2024-04-02 09:00:00', '2024-04-02 15:00:00', 360,  'COMPLETED', '경기', '이영희'),
('CASE-2024-008', '서류심사', '2024-04-18 10:00:00', '2024-04-18 12:30:00', 150,  'COMPLETED', '부산', '박준호'),
('CASE-2024-009', '데이터분석', '2024-05-10 09:00:00', '2024-05-10 18:00:00', 540, 'COMPLETED', '서울', '최수진'),
('CASE-2024-010', '현장실사', '2024-05-22 10:00:00', '2024-05-22 16:30:00', 390,  'COMPLETED', '대전', '정하늘'),
('CASE-2024-011', '서류심사', '2024-06-05 09:00:00', '2024-06-05 11:00:00', 120,  'COMPLETED', '서울', '김민수'),
('CASE-2024-012', '현장실사', '2024-06-20 10:00:00', '2024-06-20 17:30:00', 450,  'COMPLETED', '인천', '이영희'),
('CASE-2024-013', '데이터분석', '2024-07-03 09:00:00', '2024-07-04 12:00:00', 1620, 'COMPLETED', '경기', '박준호'),
('CASE-2024-014', '서류심사', '2024-07-18 10:00:00', '2024-07-18 12:00:00', 120,  'COMPLETED', '부산', '최수진'),
('CASE-2024-015', '현장실사', '2024-08-05 09:00:00', '2024-08-05 16:00:00', 420,  'COMPLETED', '서울', '정하늘'),
('CASE-2024-016', '서류심사', '2024-08-20 10:00:00', '2024-08-20 13:00:00', 180,  'COMPLETED', '대전', '김민수'),
('CASE-2024-017', '데이터분석', '2024-09-10 09:00:00', '2024-09-11 11:00:00', 1560, 'COMPLETED', '서울', '이영희'),
('CASE-2024-018', '현장실사', '2024-09-25 10:00:00', '2024-09-25 17:00:00', 420,  'COMPLETED', '인천', '박준호'),
('CASE-2024-019', '서류심사', '2024-10-08 09:00:00', '2024-10-08 11:30:00', 150,  'COMPLETED', '경기', '최수진'),
('CASE-2024-020', '현장실사', '2024-10-22 10:00:00', '2024-10-22 15:30:00', 330,  'COMPLETED', '부산', '정하늘'),
('CASE-2024-021', '데이터분석', '2024-11-05 09:00:00', '2024-11-06 14:00:00', 1740, 'COMPLETED', '서울', '김민수'),
('CASE-2024-022', '서류심사', '2024-11-18 10:00:00', '2024-11-18 12:00:00', 120,  'COMPLETED', '대전', '이영희'),
('CASE-2024-023', '현장실사', '2024-12-03 09:00:00', '2024-12-03 16:00:00', 420,  'COMPLETED', '서울', '박준호'),
('CASE-2024-024', '서류심사', '2024-12-15 10:00:00', '2024-12-15 12:00:00', 120,  'COMPLETED', '인천', '최수진'),
-- 2025 operations
('CASE-2025-001', '서류심사',   '2025-01-08 09:00:00', '2025-01-08 11:00:00', 120,  'COMPLETED', '서울', '김민수'),
('CASE-2025-002', '현장실사',   '2025-01-20 10:00:00', '2025-01-20 16:00:00', 360,  'COMPLETED', '부산', '이영희'),
('CASE-2025-003', '데이터분석', '2025-02-05 09:00:00', '2025-02-05 17:00:00', 480,  'COMPLETED', '서울', '박준호'),
('CASE-2025-004', '서류심사',   '2025-02-18 10:00:00', '2025-02-18 12:30:00', 150,  'COMPLETED', '경기', '최수진'),
('CASE-2025-005', '현장실사',   '2025-03-10 09:00:00', '2025-03-10 15:00:00', 360,  'COMPLETED', '대전', '정하늘'),
('CASE-2025-006', '서류심사',   '2025-03-25 10:00:00', '2025-03-25 12:00:00', 120,  'COMPLETED', '서울', '김민수'),
('CASE-2025-007', '데이터분석', '2025-04-08 09:00:00', '2025-04-09 11:00:00', 1560, 'COMPLETED', '인천', '이영희'),
('CASE-2025-008', '현장실사',   '2025-04-22 10:00:00', '2025-04-22 16:30:00', 390,  'COMPLETED', '부산', '박준호'),
('CASE-2025-009', '서류심사',   '2025-05-12 09:00:00', '2025-05-12 11:30:00', 150,  'COMPLETED', '서울', '최수진'),
('CASE-2025-010', '현장실사',   '2025-05-28 10:00:00', '2025-05-28 17:00:00', 420,  'COMPLETED', '경기', '정하늘'),
('CASE-2025-011', '데이터분석', '2025-06-10 09:00:00', '2025-06-11 10:00:00', 1500, 'COMPLETED', '서울', '김민수'),
('CASE-2025-012', '서류심사',   '2025-06-24 10:00:00', '2025-06-24 12:00:00', 120,  'COMPLETED', '대전', '이영희'),
('CASE-2025-013', '현장실사',   '2025-07-07 09:00:00', '2025-07-07 16:00:00', 420,  'COMPLETED', '부산', '박준호'),
('CASE-2025-014', '서류심사',   '2025-07-22 10:00:00', '2025-07-22 12:30:00', 150,  'COMPLETED', '인천', '최수진'),
('CASE-2025-015', '데이터분석', '2025-08-05 09:00:00', '2025-08-06 14:00:00', 1740, 'COMPLETED', '서울', '정하늘'),
('CASE-2025-016', '현장실사',   '2025-08-20 10:00:00', '2025-08-20 16:30:00', 390,  'COMPLETED', '경기', '김민수'),
('CASE-2025-017', '서류심사',   '2025-09-08 09:00:00', '2025-09-08 11:00:00', 120,  'COMPLETED', '대전', '이영희'),
('CASE-2025-018', '현장실사',   '2025-09-25 10:00:00', '2025-09-25 17:00:00', 420,  'COMPLETED', '서울', '박준호'),
('CASE-2025-019', '데이터분석', '2025-10-06 09:00:00', '2025-10-07 12:00:00', 1620, 'COMPLETED', '부산', '최수진'),
('CASE-2025-020', '서류심사',   '2025-10-22 10:00:00', '2025-10-22 12:00:00', 120,  'COMPLETED', '인천', '정하늘'),
('CASE-2025-021', '현장실사',   '2025-11-05 09:00:00', '2025-11-05 15:30:00', 390,  'COMPLETED', '서울', '김민수'),
('CASE-2025-022', '서류심사',   '2025-11-18 10:00:00', '2025-11-18 12:30:00', 150,  'COMPLETED', '경기', '이영희'),
('CASE-2025-023', '데이터분석', '2025-12-02 09:00:00', '2025-12-03 11:00:00', 1560, 'COMPLETED', '대전', '박준호'),
('CASE-2025-024', '현장실사',   '2025-12-15 10:00:00', '2025-12-15 16:00:00', 360,  'COMPLETED', '서울', '최수진'),
-- 2026 operations (recent — within "최근 3개월")
('CASE-2026-001', '서류심사',   '2026-01-06 09:00:00', '2026-01-06 11:30:00', 150,  'COMPLETED', '서울', '정하늘'),
('CASE-2026-002', '현장실사',   '2026-01-15 10:00:00', '2026-01-15 16:00:00', 360,  'COMPLETED', '부산', '김민수'),
('CASE-2026-003', '데이터분석', '2026-01-22 09:00:00', '2026-01-23 10:00:00', 1500, 'COMPLETED', '서울', '이영희'),
('CASE-2026-004', '서류심사',   '2026-02-03 10:00:00', '2026-02-03 12:00:00', 120,  'COMPLETED', '경기', '박준호'),
('CASE-2026-005', '현장실사',   '2026-02-10 09:00:00', '2026-02-10 15:30:00', 390,  'COMPLETED', '인천', '최수진'),
('CASE-2026-006', '서류심사',   '2026-02-18 10:00:00', '2026-02-18 12:30:00', 150,  'COMPLETED', '서울', '정하늘'),
('CASE-2026-007', '데이터분석', '2026-02-24 09:00:00', NULL,                   NULL, 'IN_PROGRESS', '대전', '김민수');
"""


def _seed_demo_tables() -> None:
    """Create demo tables and insert sample data for NL2SQL queries."""
    import psycopg2

    db_url = settings.QUERY_HISTORY_DATABASE_URL
    try:
        conn = psycopg2.connect(db_url)
        conn.autocommit = True
        cur = conn.cursor()

        # Create tables
        cur.execute(_SEED_DDL)

        # Check if 2025+ data exists (handles re-seed after adding new years)
        cur.execute("SELECT COUNT(*) FROM sales WHERE sale_date >= '2025-01-01'")
        new_count = cur.fetchone()[0]
        if new_count > 0:
            cur.execute("SELECT COUNT(*) FROM sales")
            total = cur.fetchone()[0]
            logger.info("demo_tables_already_seeded", sales_count=total)
            cur.close()
            conn.close()
            return

        # Drop old data and re-insert full dataset
        cur.execute("TRUNCATE sales RESTART IDENTITY")
        cur.execute("TRUNCATE operations RESTART IDENTITY")
        cur.execute(_SEED_DATA)
        cur.execute("SELECT COUNT(*) FROM sales")
        sales_count = cur.fetchone()[0]
        cur.execute("SELECT COUNT(*) FROM operations")
        ops_count = cur.fetchone()[0]
        logger.info("demo_tables_seeded", sales=sales_count, operations=ops_count)

        cur.close()
        conn.close()
    except Exception as exc:
        logger.warning("demo_tables_seed_failed", error=str(exc))


@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    _seed_demo_tables()
    yield
    # Shutdown (nothing to clean up)


app = FastAPI(title="Axiom Oracle", version="2.0.0", lifespan=lifespan)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.exception_handler(RateLimitExceeded)
async def rate_limit_exceeded_handler(request, exc: RateLimitExceeded):
    return JSONResponse(
        status_code=429,
        content={"success": False, "error": exc.detail},
        headers={"Retry-After": str(exc.retry_after_seconds)},
    )


app.include_router(text2sql_router)
app.include_router(health_router)
app.include_router(feedback_router)
app.include_router(meta_router)
app.include_router(events_router)
app.include_router(watch_agent_router)

@app.get("/health/live")
async def health_live():
    return {"status": "alive"}
