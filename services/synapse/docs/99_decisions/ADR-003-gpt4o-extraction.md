# ADR-003: GPT-4o Structured Output 선택

## 상태

Accepted

## 배경

비정형 비즈니스 문서 (보고서, 계약서, 분석서)에서 개체명(NER)과 관계를 추출하여 4계층 온톨로지 노드로 매핑해야 한다. 추출 결과는 JSON 형태로 구조화되어야 하며, 비즈니스 프로세스 도메인의 전문 용어를 정확히 인식해야 한다.

핵심 요구사항:
- 한국어 비즈니스 문서 NER (기업명, 인명, 금액, 일자, 프로세스 단계)
- 개체 간 관계 추출
- JSON 형태의 구조화된 출력 (파이프라인 자동화 위해)
- 개체별 신뢰도 점수 (HITL 기준)
- 높은 정확도 (비즈니스 의사결정 지원 데이터의 정보 정확성 요구)

## 검토한 옵션

### 옵션 1: GPT-4o Structured Output (strict: true)

- OpenAI GPT-4o의 Structured Output 기능
- JSON 스키마 100% 준수 보장 (strict 모드)
- 한국어 NER 성능 우수
- 비용: ~$0.008/요청 (800토큰 청크)

### 옵션 2: Claude 3.5 Sonnet + Tool Use

- Anthropic의 Claude 모델
- Tool Use 기능으로 구조화 출력
- 한국어 성능 GPT-4o와 유사
- 비용: ~$0.006/요청 (비용 약간 낮음)
- 단점: Structured Output 100% 보장 아님, tool_use 형식 변환 필요

### 옵션 3: Fine-tuned 오픈소스 모델 (Llama 3 등)

- 비즈니스 도메인 데이터로 미세 조정
- 자체 호스팅으로 비용 절감
- 단점: 라벨링 데이터 필요 (최소 1,000건), 학습 시간 4-8주, 한국어 NER 정확도 불확실

### 옵션 4: SpaCy + 규칙 기반 NER

- 전통적 NER 파이프라인
- 한국어: KoNLPy + SpaCy
- 단점: 비즈니스 도메인 커스텀 모델 필요, 관계 추출 한계, 유연성 부족

### 옵션 5: GPT-4o JSON Mode (strict: false)

- Structured Output의 느슨한 버전
- JSON 형식이지만 스키마 100% 보장 안 됨
- 비용: 옵션 1과 동일
- 단점: 간헐적 스키마 위반으로 파이프라인 에러 발생

## 선택한 결정

**GPT-4o Structured Output (strict: true)** 를 선택한다.

## 근거

1. **파싱 안정성 100%**: strict 모드에서 JSON 스키마 위반이 원천 불가능. 파이프라인의 NER → 관계추출 → 매핑 3단계에서 중간 단계 파싱 실패를 완전히 차단

2. **한국어 비즈니스 NER 성능**: GPT-4o는 한국어 비즈니스 문서에서의 개체 인식 정확도가 가장 높음 (내부 테스트 기준 F1 ~0.87). 특히 금액 정규화("3조 5천억원" → 3500000000000)와 프로세스 단계 분류에서 우수

3. **신뢰도 점수 기본 지원**: JSON 스키마에 confidence 필드를 포함시키면 GPT-4o가 자체적으로 합리적인 신뢰도 점수를 부여. 추가 모델이나 로직 불필요

4. **개발 생산성**: 프롬프트 + JSON 스키마 정의만으로 추출기 완성. Fine-tuning이나 규칙 작성 불필요

5. **유지보수 용이**: 새로운 개체 유형이나 관계 유형 추가 시 JSON 스키마에 enum 값만 추가. 모델 재학습 불필요

6. **K-AIR 기술 스택 일관성**: Axiom 전체가 OpenAI GPT-4o를 주 모델로 사용. 인프라 및 API 키 통합 관리

## 결과

### 긍정적 영향

- 추출 파이프라인 개발 기간 8일 (Fine-tuning 대비 4-6주 절감)
- JSON 파싱 에러 0%
- 프롬프트 수정만으로 추출 규칙 변경 가능
- 도메인 전문가 없이도 NER 규칙 조정 가능

### 부정적 영향

- OpenAI API 의존 (벤더 락인)
- 외부 API 호출로 인한 지연 (청크당 ~2초)
- 비용: 문서 1건당 ~$0.19 (10청크 기준)
- Rate Limit 제약 (동시 추출 작업 수 제한)

### 완화 방안

- 벤더 락인: 프롬프트와 JSON 스키마가 분리되어 있으므로, Claude 등 다른 모델로 전환 시 프롬프트만 조정 (스키마는 동일)
- 지연: 청크 병렬 처리 (asyncio.Semaphore)로 전체 문서 처리 시간 최소화
- 비용: 동일 청크 재추출 시 PostgreSQL 캐시 활용으로 30-50% 절감
- Rate Limit: Semaphore(3)으로 동시 호출 제한, 429 에러 시 지수 백오프

## 비용 상세 추정

| 시나리오 | 문서 수 | 비용/월 |
|---------|--------|--------|
| 소규모 (50문서/월) | 50 | ~$10 |
| 중규모 (200문서/월) | 200 | ~$38 |
| 대규모 (1,000문서/월) | 1,000 | ~$190 |

## 재검토 조건

- GPT-4o 비용이 현저히 인상될 때
- OpenAI API 안정성이 지속적으로 저하될 때
- 한국어 비즈니스 도메인 특화 오픈소스 NER 모델이 등장할 때 (F1 > 0.90)
- Claude 등 경쟁 모델이 Structured Output을 100% 보장하는 기능을 제공할 때
- 추출 대상 문서가 월 5,000건 이상으로 증가하여 비용이 부담될 때
