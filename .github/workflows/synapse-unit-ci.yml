name: Synapse Unit CI

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "services/synapse/**"
      - ".github/workflows/synapse-unit-ci.yml"
  push:
    branches:
      - main
    paths:
      - "services/synapse/**"
      - ".github/workflows/synapse-unit-ci.yml"

jobs:
  synapse-unit-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: insolvency_os
          POSTGRES_USER: arkos
          POSTGRES_PASSWORD: arkos
        ports:
          - 5432:5432
      neo4j:
        image: neo4j:5.18
        env:
          NEO4J_AUTH: neo4j/password
        ports:
          - 7687:7687
          - 7474:7474

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r services/synapse/requirements.txt
          pip install -e services/synapse

      - name: Wait For Infra
        shell: bash
        run: |
          set -euo pipefail

          ok=0
          for i in {1..60}; do
            if (echo > /dev/tcp/127.0.0.1/5432) >/dev/null 2>&1; then
              echo "postgres ready"
              ok=1
              break
            fi
            sleep 2
          done
          if [ "$ok" -ne 1 ]; then
            echo "postgres not ready in time" >&2
            exit 1
          fi

          ok=0
          for i in {1..60}; do
            if (echo > /dev/tcp/127.0.0.1/7687) >/dev/null 2>&1; then
              echo "neo4j ready"
              ok=1
              break
            fi
            sleep 2
          done
          if [ "$ok" -ne 1 ]; then
            echo "neo4j not ready in time" >&2
            exit 1
          fi

      - name: Run Synapse Unit Tests
        working-directory: services/synapse
        env:
          NEO4J_URI: "bolt://127.0.0.1:7687"
          NEO4J_USER: "neo4j"
          NEO4J_PASSWORD: "password"
          SCHEMA_EDIT_DATABASE_URL: "postgresql://arkos:arkos@127.0.0.1:5432/insolvency_os"
        run: pytest -q tests/unit
