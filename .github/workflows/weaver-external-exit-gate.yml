name: Weaver External Exit Gate

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "services/weaver/**"
      - ".github/workflows/weaver-external-exit-gate.yml"
  push:
    branches:
      - main
    paths:
      - "services/weaver/**"
      - ".github/workflows/weaver-external-exit-gate.yml"

jobs:
  external-exit-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: sample_enterprise
          POSTGRES_USER: sample_user
          POSTGRES_PASSWORD: sample_password
        ports:
          - 5432:5432
      neo4j:
        image: neo4j:5-community
        env:
          NEO4J_AUTH: neo4j/weaver_dev_password
        ports:
          - 7687:7687
          - 7474:7474
      mindsdb:
        image: mindsdb/mindsdb:latest
        ports:
          - 47334:47334

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r services/weaver/requirements.txt
          pip install pytest pytest-asyncio

      - name: Wait For Infra
        shell: bash
        run: |
          set -euo pipefail

          ok=0
          for i in {1..60}; do
            if (echo > /dev/tcp/127.0.0.1/5432) >/dev/null 2>&1; then
              echo "postgres ready"
              ok=1
              break
            fi
            sleep 2
          done
          if [ "$ok" -ne 1 ]; then
            echo "postgres not ready in time" >&2
            exit 1
          fi

          ok=0
          for i in {1..60}; do
            if (echo > /dev/tcp/127.0.0.1/7687) >/dev/null 2>&1; then
              echo "neo4j ready"
              ok=1
              break
            fi
            sleep 2
          done
          if [ "$ok" -ne 1 ]; then
            echo "neo4j not ready in time" >&2
            exit 1
          fi

          ok=0
          for i in {1..90}; do
            if curl -fsS http://127.0.0.1:47334/api/status >/dev/null; then
              echo "mindsdb ready"
              ok=1
              break
            fi
            sleep 2
          done
          if [ "$ok" -ne 1 ]; then
            echo "mindsdb not ready in time" >&2
            exit 1
          fi

      - name: Run Unit Tests
        working-directory: services/weaver
        run: PYTHONPATH=. pytest -q tests/unit

      - name: Run External Exit Gate
        working-directory: services/weaver
        env:
          WEAVER_RUN_E2E: "1"
          MINDSDB_URL: "http://127.0.0.1:47334"
          POSTGRES_DSN: "postgresql://sample_user:sample_password@127.0.0.1:5432/sample_enterprise"
          NEO4J_URI: "bolt://127.0.0.1:7687"
          NEO4J_USER: "neo4j"
          NEO4J_PASSWORD: "weaver_dev_password"
          WEAVER_E2E_DS_HOST: "postgres"
          WEAVER_E2E_DS_PORT: "5432"
          WEAVER_E2E_DS_DATABASE: "sample_enterprise"
          WEAVER_E2E_DS_USER: "sample_user"
          WEAVER_E2E_DS_PASSWORD: "sample_password"
          JWT_SECRET_KEY: "ci-weaver-jwt-secret"
          JWT_ALGORITHM: "HS256"
        run: make integration-external-exit-gate LOOPS=2
